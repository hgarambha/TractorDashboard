<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tractor Data Dashboard</title>
    <!-- ... (Head content same as before) ... -->
    <meta name="description" content="Live J1939 tractor data monitoring">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">üöú</span>
                    <h1>Tractor Monitor</h1>
                </div>
                <!-- ... Status area ... -->
                <div class="header-status">
                    <span class="status-dot" id="connectionStatus"></span>
                    <span class="status-text" id="statusText">Connecting...</span>
                    <span class="last-update" id="lastUpdate"></span>
                </div>
            </div>
        </header>

        <main class="main">
            <!-- Diagnostics Panel - Always Visible -->
            <section class="diagnostics-section" id="diagnosticsSection">
                <div class="diag-header">
                    <h2>üîß System Diagnostics</h2>
                    <button class="history-btn" id="showHistoryBtn" onclick="window.dashboard.showDiagHistory()">
                        üìã History
                    </button>
                </div>
                <div class="diag-status" id="diagStatus">
                    <div class="status-indicator ok" id="statusIndicator">
                        <span class="status-icon">‚úÖ</span>
                        <span class="status-text">All Systems OK</span>
                    </div>
                </div>
                <div class="fault-list" id="faultList" style="display: none;">
                    <!-- Active faults will be listed here -->
                </div>
            </section>

            <!-- Diagnostic History Modal -->
            <div class="modal-overlay" id="historyModal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üìã Diagnostic History</h2>
                        <button class="modal-close" onclick="window.dashboard.closeHistoryModal()">‚úï</button>
                    </div>
                    <div class="modal-tabs">
                        <button class="tab-btn active" data-status="all"
                            onclick="window.dashboard.filterHistory('all')">All</button>
                        <button class="tab-btn" data-status="active"
                            onclick="window.dashboard.filterHistory('active')">Active</button>
                        <button class="tab-btn" data-status="resolved"
                            onclick="window.dashboard.filterHistory('resolved')">Resolved</button>
                    </div>
                    <div class="modal-filters"
                        style="padding: 10px 20px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid var(--border-color);">
                        <span style="color: var(--text-secondary); font-size: 0.9em;">Filter Date:</span>
                        <input type="date" id="histStart" class="date-input"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; padding: 5px; border-radius: 4px;">
                        <span style="color: var(--text-secondary);">-</span>
                        <input type="date" id="histEnd" class="date-input"
                            style="background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; padding: 5px; border-radius: 4px;">
                        <button onclick="window.dashboard.showDiagHistory()"
                            style="background: var(--accent-primary); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Apply</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="loading">Loading history...</div>
                    </div>
                </div>
            </div>

            <!-- Gauges -->
            <section class="gauges-section">
                <!-- RPM Card -->
                <div class="gauge-card" onclick="openAnalysis('EngineSpeed')">
                    <div class="gauge-header"><span class="gauge-icon">‚öôÔ∏è</span><span class="gauge-title">Engine
                            RPM</span></div>
                    <div class="gauge-value"><span id="rpmValue">--</span><span class="gauge-unit">RPM</span></div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="rpmFill" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Speed Card -->
                <div class="gauge-card" onclick="openAnalysis('WheelBasedVehicleSpeed')">
                    <div class="gauge-header"><span class="gauge-icon">üöú</span><span class="gauge-title">Speed</span>
                    </div>
                    <div class="gauge-value"><span id="speedValue">--</span><span class="gauge-unit">km/h</span></div>
                    <div class="gauge-bar">
                        <div class="gauge-fill speed-fill" id="speedFill" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Fuel Card -->
                <div class="gauge-card" onclick="openAnalysis('FuelLevel')">
                    <div class="gauge-header"><span class="gauge-icon">‚õΩ</span><span class="gauge-title">Fuel
                            Level</span></div>
                    <div class="gauge-value"><span id="fuelValue">--</span><span class="gauge-unit">%</span></div>
                    <div class="gauge-bar">
                        <div class="gauge-fill fuel-fill" id="fuelFill" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Temp Card -->
                <div class="gauge-card" onclick="openAnalysis('EngineCoolantTemp')">
                    <div class="gauge-header"><span class="gauge-icon">üå°Ô∏è</span><span class="gauge-title">Coolant
                            Temp</span></div>
                    <div class="gauge-value"><span id="tempValue">--</span><span class="gauge-unit">¬∞C</span></div>
                    <div class="gauge-bar">
                        <div class="gauge-fill temp-fill" id="tempFill" style="width: 0%"></div>
                    </div>
                </div>
            </section>

            <!-- Charts & Map -->
            <section class="charts-section">
                <div class="chart-card">
                    <div class="card-header">
                        <h2>Historical Trends</h2>
                        <div class="time-selector"> <!-- Buttons ... -->
                            <button class="time-btn active" data-range="1h">1H</button>
                            <button class="time-btn" data-range="6h">6H</button>
                            <button class="time-btn" data-range="24h">24H</button>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="historyChart"></canvas></div>
                </div>

                <div class="map-card">
                    <div class="card-header">
                        <h2>Location Tracking</h2>
                        <div class="map-controls">
                            <button class="map-btn active" id="showLiveBtn">Live</button>
                            <button class="map-btn" id="showHistoryBtn">History</button>
                            <button class="map-btn" onclick="window.dashboard.toggleMapFullscreen()"
                                title="Maximize Map">‚õ∂</button>
                        </div>
                    </div>
                    <div id="map"></div>
                    <div class="location-info">
                        <div class="coord"><span class="coord-label">Lat:</span><span class="coord-value"
                                id="latValue">--</span></div>
                        <div class="coord"><span class="coord-label">Lon:</span><span class="coord-value"
                                id="lonValue">--</span></div>
                        <div class="coord"><span class="coord-label">Heading:</span><span class="coord-value"
                                id="headingValue">--¬∞</span></div>
                    </div>
                </div>
            </section>

            <!-- Stats -->
            <section class="stats-section">
                <!-- ... (Same stats cards) ... -->
                <div class="stat-card" onclick="openAnalysis('EngineOilPressure')">
                    <span class="stat-icon">üõ¢Ô∏è</span>
                    <div class="stat-content"><span class="stat-value" id="oilPressure">--</span><span
                            class="stat-label">Oil Pressure (kPa)</span></div>
                </div>
                <div class="stat-card" onclick="openAnalysis('AmbientAirTemp')">
                    <span class="stat-icon">üí®</span>
                    <div class="stat-content"><span class="stat-value" id="ambientTemp">--</span><span
                            class="stat-label">Ambient Temp (¬∞C)</span></div>
                </div>
                <div class="stat-card" onclick="openAnalysis('EnginePercentTorque')">
                    <span class="stat-icon">üìä</span>
                    <div class="stat-content"><span class="stat-value" id="torque">--</span><span
                            class="stat-label">Engine Torque (%)</span></div>
                </div>
                <div class="stat-card" onclick="openAnalysis('Altitude')">
                    <span class="stat-icon">‚õ∞Ô∏è</span>
                    <div class="stat-content"><span class="stat-value" id="altitude">--</span><span
                            class="stat-label">Altitude (m)</span></div>
                </div>
            </section>
        </main>

        <footer class="footer">
            <p>J1939 Tractor Data Logger</p>
        </footer>
    </div>

    <!-- CONFIGURATION -->
    <script>
        // Paste your Apps Script Web App URL here!
        window.DASHBOARD_CONFIG = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbxfLHeL6Iq3_9tm7aZCoC_gjj7AU_mpwl6bSF1gYEM9jbll9fqnw1XknoAAhP9UaRS-GQ/exec',
            refreshInterval: 10000
        };
    </script>

    <script src="dashboard.js"></script>
    <script src="map.js"></script>
    <script src="analysis.js"></script>
    <script>
        // Init Analysis when dashboard is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for dashboard instance
            setTimeout(() => {
                if (window.dashboard) window.initAnalysis(window.dashboard);
            }, 500);
        });

        // Helper to open analysis
        function openAnalysis(param) {
            if (window.analysis) window.analysis.open(param);
        }
    </script>
</body>

</html>
